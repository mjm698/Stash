<link rel="import" href="/static/components/core-ajax/core-ajax.html">
<link rel="import" href="content-element.html">

<polymer-element name="content-list" attributes="stashId userId newContent">
    <template>
        <core-ajax id="getContent"
                   method="get"
                   url="/content/"
                   headers='{"USERID":"{{ userId }}",
                             "STASHID": "{{ stashId }}"}'
                   params='{"stashId":"{{ stashId}}"}'
                   response="{{data}}"
                   handleAs="json">
        </core-ajax>
        <core-ajax id="viewContent"
                   method="get"
                   url="/view/"
                   params='{"contentId":"{{viewContentId}}"}'
                   response="{{data}}"
                   on-core-response="{{openSuccess}}"
                   handleAs="">
        </core-ajax>
        <div layout vertical id='contentList'>
            <template repeat="{{content in data}}">
                <content-element data={{content}} userId={{userId}} on-click={{openContent}}></content-element>
            </template>
        </div>
    </template>
    <script>
        Polymer({ 
            selectedContent: "",
            ready: function()
            {
                this.addEventListener('hideContent', this.hideContent)
                this.addEventListener('addNewContent', this.addNewContent)
            },
            hideContent: function(e)
            {
                for(var index = 0; index < this.data.length; ++index)
                {
                    if(e.detail.id == this.data[index].id)
                    {
                        this.data.splice(index, 1);
                        break;
                    }
                }
            },
            stashIdChanged: function(oldValue, newValue)
            {
                this.$.getContent.go();
            },
            newContentChanged: function(oldValue, newValue)
            {
                if(newValue)
                {
                    this.data.push(newValue);
                }
            },
            openContent: function(e, isClicked, element)
            {
                this.viewContentId = element.data.id;
                window.location.href = "/view/?id=" + element.data.id;
            },
            openSuccess: function(a,b,c)
            {
                this.$.viewContent.go();
            }
        });
    </script>
</polymer-element>
